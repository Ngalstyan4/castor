import glob
Import('env')

src = [
    "runtime.c",
    "debug.c",
    "util.c",
    "fdinfo.c",
    "events.c",
    "events_freebsd.c",
    "events_mem.c",
    #XXX "events_posix.c",
    #XXX disabled semaphor support as we need to do some book keep
    #XXX previously done by libc when switching to libsys
    "events_proc.c",
    "events_sysv.c",
    "events_llvm.c",
    "rr_assert.c",
    "rr_fdprintf.c",
    "system.c",
    "syscall.S",
    "cerror.S",
    "__error.c",
]

for o in Glob("lib/*.c"):
    src.append(str(o))

env_libsys = env.Clone()

# Made global to make compilation_db work
env_libsys["CPPPATH"].append("#sysroot-src/lib/libc/include")

env_libsys["CFLAGS"].append("-DCASTOR_RUNTIME")
env_libsys["ASFLAGS"].append("-DPIC")
env_libsys["LINKFLAGS"].append("-nodefaultlibs")
env_libsys["LINKFLAGS"].append("-Wl,--version-script=lib/Runtime/Version.map")

env_libsys.SharedLibrary("libsys_castor.so", src, LIBS = ["compiler_rt"])

#rt = env.CopyFile("$SYSROOT/usr/lib/libCastorRuntime.a", 
#"#build/lib/Runtime/libCastorRuntime.a")
#env.Alias("CastorRuntime", rt)

